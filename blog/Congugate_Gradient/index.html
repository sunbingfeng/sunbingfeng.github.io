<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Conjugate Gradient Method - Bill's Tech Blog</title>
    <meta name="description" content="To Be Excellent">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/assets/favicon.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- Syntax Highlighting -->
    <link rel="stylesheet" href="/assets/css/monokai.css">
    
    <!-- Styles -->
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --text-color: #1f2937;
            --background-color: #ffffff;
            --card-background: #f8fafc;
            --gradient-start: #2563eb;
            --gradient-end: #1e40af;
            --header-height: 4rem;
        }

        [data-theme="dark"] {
            --text-color: #f3f4f6;
            --background-color: #111827;
            --card-background: #1f2937;
            --gradient-start: #1e40af;
            --gradient-end: #1e3a8a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: var(--background-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Syntax Highlighting */
        .highlight {
            background: #272822;
            color: #f8f8f2;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
        }
        
        .highlight pre {
            margin: 0;
            background: none;
            border: none;
            padding: 0;
        }
        
        .highlight code {
            background: none;
            border: none;
            padding: 0;
            color: inherit;
            font-family: 'Courier New', monospace;
        }
        
        /* Typography and Heading Styles */
        h1, h2, h3, h4, h5, h6 {
            color: var(--text-color);
            font-weight: 600;
            line-height: 1.3;
            margin-top: 0;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
            margin-top: 3rem;
        }
        
        h2 {
            font-size: 2rem;
            margin-bottom: 1.25rem;
            margin-top: 3rem;
            padding-top: 1rem;
            border-top: 2px solid var(--card-background);
        }
        
        h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            margin-top: 2.5rem;
            padding-top: 0.75rem;
            /* border-top: 1px solid var(--card-background); */
        }
        
        h4 {
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
            margin-top: 2rem;
        }
        
        h5 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            margin-top: 1.5rem;
        }
        
        h6 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            margin-top: 1.5rem;
        }
        
        /* Paragraph and Text Spacing */
        p {
            margin-bottom: 1.5rem;
            line-height: 1.8;
            text-align: justify;
        }
        
        /* List spacing */
        ul, ol {
            margin-bottom: 1.5rem;
            padding-left: 1.5rem;
            margin-left: 0;
        }
        
        li {
            margin-bottom: 0.75rem;
            line-height: 1.7;
            padding-left: 0.5rem;
        }
        
        /* Nested list spacing */
        ul ul, ol ol, ul ol, ol ul {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            padding-left: 1.25rem;
        }
        
        /* List item markers */
        ul li::marker {
            color: var(--gradient-start);
        }
        
        ol li::marker {
            color: var(--gradient-start);
            font-weight: 600;
        }
        
        /* Blockquote spacing */
        blockquote {
            margin: 2rem 0;
            padding: 1rem 1.5rem;
            border-left: 4px solid var(--gradient-start);
            background: var(--card-background);
            border-radius: 0.5rem;
            font-style: italic;
        }
        
        blockquote p {
            margin-bottom: 1rem;
        }
        
        blockquote p:last-child {
            margin-bottom: 0;
        }
        
        /* Code inline spacing */
        code {
            background: var(--card-background);
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            background: var(--background-color);
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        table th {
            background: var(--gradient-start);
            color: white;
            font-weight: 600;
            text-align: left;
            padding: 1rem 1.5rem;
            border-bottom: 2px solid var(--gradient-end);
            font-size: 1rem;
        }
        
        table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--card-background);
            vertical-align: top;
            line-height: 1.6;
        }
        
        table tr:last-child td {
            border-bottom: none;
        }
        
        table tr:hover {
            background: var(--card-background);
            transition: background-color 0.2s ease;
        }
        
        table tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.02);
        }
        
        table tr:nth-child(even):hover {
            background: var(--card-background);
        }
        
        /* Responsive table */
        @media (max-width: 768px) {
            table {
                font-size: 0.9rem;
            }
            
            table th,
            table td {
                padding: 0.75rem 1rem;
            }
        }
        
        /* Figure and Image Styles */
        figure {
            margin: 2.5rem 0;
            text-align: center;
            background: var(--card-background);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        figure img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        figcaption {
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 0.95rem;
          font-style: italic;
            color: var(--text-color);
            opacity: 0.8;
            line-height: 1.5;
            margin-top: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 0.5rem;
            border-left: 4px solid var(--gradient-start);
        }
        
        /* Center image class for backward compatibility */
        .center_img {
            display: block;
            margin: 0 auto;
        }
        
        /* Responsive figure adjustments */
        @media (max-width: 768px) {
            figure {
                margin: 2rem 0;
                padding: 1rem;
            }
            
            figcaption {
                font-size: 0.9rem;
                padding: 0.5rem 0.75rem;
            }
        }
        
        /* Header Styles */
        .site-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: var(--background-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 2rem;
            backdrop-filter: blur(10px);
        }

        .site-header .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .site-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-links a:hover {
            color: var(--primary-color);
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 0.5rem;
            font-size: 1.25rem;
        }

        /* Main Content */
        .main-content {
            margin-top: var(--header-height);
            min-height: calc(100vh - var(--header-height));
        }

        /* Footer */
        .site-footer {
            background: var(--card-background);
            padding: 2rem 0;
            margin-top: 4rem;
            text-align: center;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .footer-section {
            margin-bottom: 1.5rem;
        }

        .footer-section p {
            color: var(--text-color);
            opacity: 0.8;
            text-align: center;
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .site-header {
                padding: 0 1rem;
            }

            .footer-content {
                padding: 0 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <a href="/" class="site-title">Bill's Tech Blog</a>
            <nav>
                <ul class="nav-links">
                    <li><a href="/blog">Blog</a></li>
                    <li><a href="/about">About</a></li>
                </ul>
            </nav>
            <button class="theme-toggle" aria-label="Toggle theme">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </header>

    <main class="main-content">
        <!-- Add Font Awesome for TOC icon -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer">
<style>
    .post-container {
        display: flex;                    /* Use flexbox instead of grid */
        gap: 2rem;
        max-width: 1200px;
        margin: 2rem auto 0;              /* Add top margin for spacing from header */
        padding: 0 1rem;
    }

    /* Main content area (left column) */
    .post-content-wrapper {
        flex: 1;                          /* Take remaining space */
        min-width: 0;                     /* Allow shrinking */
    }

    /* TOC area (right column) */
    .toc-container {
        flex: 0 0 300px;                  /* Fixed width, don't grow/shrink */
        position: sticky;                  /* Make it stick when scrolling */
        top: 2rem;                        /* Distance from top when sticky */
        height: fit-content;               /* Only take needed height */
    }

    /* Ensure TOC doesn't show on mobile */
    @media (max-width: 768px) {
        .post-container {
            flex-direction: column;        /* Stack vertically on mobile */
        }
        
        .toc-container {
            flex: none;                    /* Reset flex properties */
            position: static;              /* Remove sticky positioning */
            width: 100%;                   /* Full width on mobile */
            order: -1;                     /* Show TOC before content on mobile */
        }
    }

    .post-header {
        background: linear-gradient(135deg, var(--gradient-start), var(--gradient-start), var(--gradient-end));
        color: white;
        padding: clamp(5rem, 12vw, 10rem) clamp(1rem, 3vw, 2rem) clamp(4rem, 10vw, 7rem);
        text-align: center;
        margin-top: 0;                          /* Remove negative margin */
        position: relative;
        width: 100vw;                           /* Full viewport width */
        margin-left: calc(-50vw + 50%);         /* Break out of container */
        margin-right: calc(-50vw + 50%);        /* Break out of container */
        margin-bottom: 2rem;                    /* Add space below header */
    }

    .post-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.2) 100%);
        z-index: 1;
    }

    .post-content-wrapper {
        position: relative;
        z-index: 2;
        max-width: 800px;
        margin: 0 auto;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        padding: 0 1rem;
    }

    .post-title {
        font-size: clamp(2rem, 5vw, 3rem);
        font-weight: 800;
        margin: 0;
        line-height: 1.2;
        background: linear-gradient(to right, #fff, #e2e8f0);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        word-wrap: break-word;
        animation: fadeInUp 1s ease;
        animation-fill-mode: both;
        padding: 0 0.5rem;
    }

    .post-meta {
        font-size: clamp(0.875rem, 2vw, 1rem);
        color: rgba(255, 255, 255, 0.9);
        margin: 0;
        animation: fadeInUp 1s ease 0.2s;
        animation-fill-mode: both;
    }

    .post-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
        margin: 0;
        animation: fadeInUp 1s ease 0.4s;
        animation-fill-mode: both;
    }

    .post-tags .tag {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        transition: all 0.3s ease;
    }

    .post-tags .tag:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-1px);
    }

    .post-content {
        font-size: clamp(1rem, 2.5vw, 1.1rem);
        line-height: 1.8;
        max-width: 800px;
        margin: 0 auto;
        width: 100%;
        padding: 2rem 1rem;
        margin-top: 1rem;                       /* Add space above content */
    }

    /* TOC Styles */
    .toc-container {
        position: sticky;
        top: calc(var(--header-height) + 1rem);
        max-height: calc(100vh - var(--header-height) - 2rem);
        overflow-y: auto;
        padding: 1.5rem;
        background: var(--card-background);
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-size: 0.9rem;
        display: none; /* Hide by default on mobile */
    }

    .toc-container h2 {
        font-size: 1.25rem;
        margin: 0 0 1rem 0;
        color: var(--text-color);
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--primary-color);
    }

    .toc {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .toc ul {
        list-style: none;
        padding-left: 1rem;
        margin: 0.5rem 0;
    }

    .toc li {
        margin: 0.5rem 0;
    }

    .toc a {
        color: var(--text-color);
        text-decoration: none;
        transition: all 0.3s ease;
        display: block;
        padding: 0.25rem 0;
        opacity: 0.8;
    }

    .toc a:hover {
        color: var(--primary-color);
        opacity: 1;
        transform: translateX(5px);
    }

    .toc a.active {
        color: var(--primary-color);
        font-weight: 600;
        opacity: 1;
    }

    /* Post content styles */
    .post-content h1,
    .post-content h2,
    .post-content h3,
    .post-content h4 {
        scroll-margin-top: calc(var(--header-height) + 2rem);
    }

    .post-content img {
        max-width: 100%;
        height: auto;
        border-radius: 0.5rem;
        margin: 1.5rem 0;
    }

    .post-content pre {
        overflow-x: auto;
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1.5rem 0;
        font-size: 0.9rem;
    }

    .post-content code {
        font-size: 0.9em;
        padding: 0.2em 0.4em;
        border-radius: 0.25rem;
    }

    .post-content blockquote {
        border-left: 4px solid var(--primary-color);
        margin: 1.5rem 0;
        padding: 1rem 1.5rem;
        background: var(--card-background);
        border-radius: 0 0.5rem 0.5rem 0;
    }

    /* Mobile TOC Toggle */
    .toc-toggle {
        display: none;
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: var(--primary-color);
        color: white;
        padding: 0.75rem;
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        cursor: pointer;
        border: none;
        width: 3rem;
        height: 3rem;
        font-size: 1.25rem;
    }

    @media (max-width: 1024px) {
        .post-container {
            grid-template-columns: 1fr;
            padding: 0 1rem;
        }

        .toc-container {
            display: none; /* Hide TOC by default on tablet */
        }
    }

    @media (max-width: 768px) {
        .post-header {
            padding: clamp(5rem, 12vw, 8rem) 1rem clamp(3rem, 8vw, 5rem);
        }

        .post-content-wrapper {
            gap: 1rem;
            padding: 0 1rem;
        }

        .post-title {
            font-size: clamp(1.75rem, 4vw, 2.5rem);
            line-height: 1.3;
            padding: 0 0.5rem;
        }

        .post-meta {
            font-size: 0.9rem;
            padding: 0 0.5rem;
        }

        .post-tags {
            padding: 0 0.5rem;
            gap: 0.375rem;
        }

        .post-tags .tag {
            font-size: 0.8125rem;
            padding: 0.2rem 0.625rem;
        }

        .post-content {
            padding: 1.5rem 1rem;
        }

        /* Restore TOC mobile styles */
        .toc-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            max-height: 100vh;
            margin: 0;
            border-radius: 0;
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            padding: 2rem 1rem;
        }

        .toc-container.active {
            transform: translateX(0);
        }

        .toc-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toc-toggle.active {
            background: var(--secondary-color);
        }

        /* Rest of mobile styles */
        .post-content h1 {
            font-size: clamp(1.5rem, 4vw, 2rem);
            margin-top: 2rem;
        }

        .post-content h2 {
            font-size: clamp(1.25rem, 3.5vw, 1.75rem);
            margin-top: 1.75rem;
        }

        .post-content h3 {
            font-size: clamp(1.1rem, 3vw, 1.5rem);
            margin-top: 1.5rem;
        }

        .post-content h4 {
            font-size: clamp(1rem, 2.5vw, 1.25rem);
            margin-top: 1.25rem;
        }

        .post-content p {
            margin: 1rem 0;
        }

        .post-content img {
            margin: 1.25rem 0;
        }

        .post-content pre {
            margin: 1.25rem 0;
            padding: 0.75rem;
            font-size: 0.85rem;
        }

        .post-content blockquote {
            margin: 1.25rem 0;
            padding: 0.75rem 1rem;
        }

        .comments-wrapper {
            padding: 2rem 0;
            margin-top: 2rem;
        }

        .comments-container {
            padding: 0 1rem;
        }

        .comments-container h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .utterances-container {
            padding: 0 0.5rem;
        }
    }

    @media (max-width: 480px) {
        .post-header {
            padding: clamp(4rem, 10vw, 6rem) 0.75rem clamp(2.5rem, 6vw, 4rem);
        }

        /* Restore TOC toggle button styles for very small screens */
        .toc-toggle {
            bottom: 1rem;
            right: 1rem;
            width: 2.5rem;
            height: 2.5rem;
            font-size: 1rem;
        }

        /* Rest of very small screen styles */
        .post-content-wrapper {
            padding: 0 0.75rem;
        }

        .post-title {
            font-size: clamp(1.5rem, 3.5vw, 2rem);
            line-height: 1.4;
            padding: 0 0.25rem;
        }

        .post-content {
            padding: 1.25rem 0.75rem;
            font-size: 0.95rem;
        }

        .post-content h1 {
            font-size: clamp(1.4rem, 3.5vw, 1.8rem);
        }

        .post-content h2 {
            font-size: clamp(1.2rem, 3vw, 1.6rem);
        }

        .post-content h3 {
            font-size: clamp(1.1rem, 2.5vw, 1.4rem);
        }

        .post-content h4 {
            font-size: clamp(1rem, 2vw, 1.2rem);
        }

        .comments-wrapper {
            padding: 1.5rem 0;
        }

        .comments-container h2 {
            font-size: 1.35rem;
            margin-bottom: 1.25rem;
        }

        .utterances-container {
            padding: 0 0.25rem;
        }
    }

    /* Comments Section Styles */
    .comments-wrapper {
        width: 100vw;
        background: var(--card-background);
        padding: 3rem 0;
        margin-top: 3rem;
        margin-left: calc(-50vw + 50%);
        margin-right: calc(-50vw + 50%);
    }

    .comments-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    .comments-container h2 {
        font-size: 1.75rem;
        margin-bottom: 2rem;
        color: var(--text-color);
    }

    .utterances-container {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
    }

    /* Utterances specific styles */
    .utterances-container iframe {
        width: 100% !important;
        border: none !important;
    }

    [data-theme="dark"] .utterances-container {
        background: var(--card-background);
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<!-- Post Header - Outside the flexbox container -->
<div class="post-header">
    <div class="post-content-wrapper">
        <h1 class="post-title">Conjugate Gradient Method</h1>
        <div class="post-meta">
            <span>April 11, 2025</span>
        </div>
        
        <div class="post-tags">
            
            <span class="tag">Y-2025</span>
            
            <span class="tag">math</span>
            
        </div>
        
    </div>
</div>

<!-- Post Container - Only for content and TOC -->
<div class="post-container">
    <div class="post-content">
        <blockquote>
  <p>本文是AI Chat系列文章的第4篇，介绍基于Conjugate Gradient的线性求解方法。</p>
</blockquote>

<h2 id="introduction">Introduction</h2>

<p>在优化求解问题中，经常会碰到类似\(Ax=b\)的线性方程求解问题。如果A是对称矩阵，那么可以调用常规的LU分解或者Cholskey分解来完成方程式的求解。</p>

<p>这类求解方法没啥好说的，今天来介绍一个基于迭代的求解方法。正如文章标题所述，该方法主要基于Conjugate Gradient，下面基于AI的配合，详细阐述一下。</p>

<h2 id="ask-the-ai">Ask the AI</h2>

<blockquote>
  <p>Me: Responding to Ax=b problems where A is large and sparse, direct methods, i.e, LU decomposition, are computationally expensive. Can you show me how to solve it through Conjugate Gradient method?</p>

  <p>AI: Certainly! Iterative methods are particularly useful for solving large systems of linear equations, especially when the matrix involved is sparse or too large for direct methods to be efficient. One of the most common iterative methods for solving systems of linear equations is the <strong>Conjugate Gradient (CG) method</strong>. Here’s a more detailed explanation:</p>
</blockquote>

<p>The Conjugate Gradient (CG) method is an iterative algorithm for solving systems of linear equations \(Ax = b\), where \(A\) is a symmetric positive definite matrix. Here’s a step-by-step derivation of the method:</p>

<h3 id="problem-setup"><strong>Problem Setup:</strong></h3>

<p>Given a symmetric positive definite matrix \(A\) and a vector \(b\), we want to find the vector \(x\) that minimizes the quadratic function:</p>

\[f(x) = \frac{1}{2} x^T A x - b^T x\]

<p>The gradient of this function is:</p>

\[\nabla f(x) = Ax - b\]

<p>Setting the gradient to zero gives the system of equations:</p>

\[Ax = b\]

<h3 id="derivation-of-the-cg-method"><strong>Derivation of the CG Method:</strong></h3>

<ol>
  <li>
<strong>Initialization</strong>:
    <ul>
      <li>Start with an initial guess \(x_0\).</li>
      <li>Compute the initial residual \(r_0 = b - Ax_0\).</li>
      <li>Set the initial search direction \(p_0 = r_0\).</li>
    </ul>
  </li>
  <li>
<strong>Iterative Process</strong>:
    <ul>
      <li>For each iteration \(k\), perform the following steps:</li>
    </ul>
  </li>
  <li>
<strong>Compute Step Size</strong>:
    <ul>
      <li>Calculate the step size \(\alpha_k\) using the formula:</li>
    </ul>

\[\alpha_k = \frac{r_k^T r_k}{p_k^T A p_k}\]
  </li>
  <li>
<strong>Update the Solution</strong>:
    <ul>
      <li>Update the solution vector \(x\):</li>
    </ul>

\[x_{k+1} = x_k + \alpha_k p_k\]
  </li>
  <li>
<strong>Update the Residual</strong>:
    <ul>
      <li>Compute the new residual:</li>
    </ul>

\[r_{k+1} = r_k - \alpha_k A p_k\]
  </li>
  <li>
<strong>Check for Convergence</strong>:
    <ul>
      <li>If the norm of the residual \(r_{k+1}\) is below a certain threshold, the algorithm has converged.</li>
    </ul>
  </li>
  <li>
<strong>Compute the New Search Direction</strong>:
    <ul>
      <li>Calculate the coefficient \(\beta_k\):</li>
    </ul>

\[\beta_k = \frac{r_{k+1}^T r_{k+1}}{r_k^T r_k}\]
  </li>
  <li>
<strong>Update the Search Direction</strong>:
    <ul>
      <li>Update the search direction:</li>
    </ul>

\[p_{k+1} = r_{k+1} + \beta_k p_k\]
  </li>
</ol>

<h3 id="convergence">Convergence:</h3>

<p>The CG method converges in at most \(n\) iterations for an \(n \times n\) matrix, but it often converges much faster in practice. The method is efficient because it only requires matrix-vector multiplications and does not need to store the entire matrix \(A\).</p>

<h3 id="summary">Summary:</h3>

<p>The Conjugate Gradient method is powerful for solving large, sparse systems of linear equations due to its efficiency and the fact that it only requires the matrix \(A\) to be symmetric and positive definite. The method iteratively refines the solution by minimizing the quadratic form associated with the system, using conjugate directions to ensure convergence.</p>

<p>这里需要补充说明一下，\(\alpha_k\) 为什么取这个值，继续跟AI聊一下。</p>

<blockquote>
  <p>Me: I think the derivation of the update of the \(\alpha_k\) might be to minimize the quadratic test function \(\frac{1}{2}x^T A x - x^T b\). Through this way, I can obtain the specified formula \(\alpha_k\) What’s your opinion?</p>

  <p>AI: Yes, you’re absolutely right! The correct way to derive \(\alpha_k\) is through minimizing the quadratic objective function. Let me show the correct derivation:</p>
</blockquote>

<h3 id="correct-derivation-of-alpha_k">Correct Derivation of \(\alpha_k\)</h3>

<p>The quadratic objective function is:</p>

\[f(x) = \frac{1}{2}x^T A x - x^T b\]

<ol>
  <li>
<strong>Update Step</strong>:
    <ul>
      <li>At each iteration, we update \(x\) along the search direction:</li>
    </ul>

\[x_{k+1} = x_k + \alpha_k p_k\]
  </li>
  <li>
<strong>Minimizing the Objective Function</strong>:
    <ul>
      <li>Substitute the update into the objective function:</li>
    </ul>

\[f(x_k + \alpha_k p_k) = \frac{1}{2}(x_k + \alpha_k p_k)^T A (x_k + \alpha_k p_k) - (x_k + \alpha_k p_k)^T b\]
  </li>
  <li>
<strong>Take Derivative with Respect to \(\alpha_k\)</strong>:
    <ul>
      <li>Set the derivative to zero:</li>
    </ul>

\[\frac{d}{d\alpha_k}f(x_k + \alpha_k p_k) = p_k^T A x_k + \alpha_k p_k^T A p_k - p_k^T b = 0\]
  </li>
  <li>
<strong>Using the Residual</strong>:
    <ul>
      <li>Note that \(r_k = b - A x_k\)</li>
      <li>Therefore, \(p_k^T(b - A x_k) = p_k^T r_k\)</li>
    </ul>
  </li>
  <li>
    <p><strong>Solve for \(\alpha_k\)</strong>:</p>

\[\alpha_k = \frac{p_k^T r_k}{p_k^T A p_k} = \frac{r_k^T r_k}{p_k^T A p_k}\]
  </li>
</ol>

<p>This derivation through minimizing the quadratic objective function gives us the correct formula for \(\alpha_k\). This approach is more principled than trying to minimize \(r_{k+1}^2\) directly, as it aligns with the fundamental goal of the Conjugate Gradient method: finding the minimum of the quadratic form.</p>

<p>The last equality \(\frac{p_k^T r_k}{p_k^T A p_k} = \frac{r_k^T r_k}{p_k^T A p_k}\) holds because at each iteration, \(p_k\) is a linear combination of \(r_k\) and previous search directions.</p>

<p>This derivation helps explain why the Conjugate Gradient method is so effective at minimizing the quadratic objective function and solving the linear system \(Ax = b\).</p>

<p>补充说明一下，二次代价函数\(f(x_k)\)的一阶导为\(A x_k - b\)，而CG求解过程中所谓的残差\(r_k=b - A x_k\)其实就是负梯度方向。\(x_{k+1}\)更新是沿着\(p_k\)方向更新\(\alpha_k\)步进，该本质就是沿着负梯度方向的线性搜索。\(p_0\)初始值选择就是\(r_0\)的方向，\(p_{k+1}\)更新基于\(r_{k+1}\)和\(p_k\)的线性组合，因此可以近似认为\(p_k\)还是沿着负梯度方向，也即与\(r_k\)同向。</p>

<blockquote>
  <p>Me: Can you give me more theory support to this method?</p>

  <p>AI: Yes, the Conjugate Gradient (CG) method is supported by several theoretical foundations that explain its efficiency and convergence properties. Here are some key theoretical aspects:</p>
</blockquote>

<h3 id="krylov-subspace-methods"><strong>Krylov Subspace Methods</strong></h3>

<p>The CG method is a type of Krylov subspace method. These methods iteratively build a solution by exploring the Krylov subspace, which is generated by the initial residual and the matrix \(A\):</p>

\[\mathcal{K}_k(A, r_0) = \text{span}\{r_0, Ar_0, A^2r_0, \ldots, A^{k-1}r_0\}\]

<p>The CG method finds the best approximation to the solution within this subspace, minimizing the error in the \(A\)-norm.</p>

<h3 id="conjugate-directions"><strong>Conjugate Directions</strong></h3>

<p>The method constructs a sequence of search directions that are \(A\)-conjugate, meaning they satisfy:</p>

\[p_i^T A p_j = 0 \quad \text{for} \quad i \neq j\]

<p>This property ensures that each step in the algorithm is orthogonal to the previous ones in the transformed space defined by \(A\), leading to efficient convergence.</p>

<h3 id="quadratic-minimization"><strong>Quadratic Minimization</strong></h3>

<p>The CG method minimizes the quadratic form:</p>

\[f(x) = \frac{1}{2} x^T A x - b^T x\]

<p>By iteratively updating the solution, the method reduces the residual and the error in the solution, converging to the minimum of the quadratic form.</p>

<h3 id="convergence-properties"><strong>Convergence Properties</strong></h3>

<ul>
  <li>
<strong>Finite Termination</strong>: For an \(n \times n\) matrix, the CG method converges in at most \(n\) iterations, assuming exact arithmetic. In practice, it often converges much faster.</li>
  <li>
<strong>Error Reduction</strong>: The error in the solution decreases exponentially with each iteration, especially when the eigenvalues of \(A\) are well-clustered.</li>
</ul>

<h3 id="spectral-properties"><strong>Spectral Properties</strong></h3>

<p>The convergence rate of the CG method is influenced by the eigenvalues of the matrix \(A\). The method converges faster when the eigenvalues are tightly clustered, as this leads to a smaller condition number.</p>

<h3 id="preconditioning"><strong>Preconditioning</strong></h3>

<p>To improve convergence, preconditioning can be applied. A preconditioner \(M\) is used to transform the system into one with more favorable spectral properties:</p>

\[M^{-1}Ax = M^{-1}b\]

<p>The preconditioned system has a better-conditioned matrix, leading to faster convergence.</p>

<p>These theoretical foundations explain why the CG method is effective for solving large, sparse systems of linear equations, particularly when the matrix is symmetric and positive definite. The method’s reliance on conjugate directions and its ability to minimize the quadratic form efficiently are key to its success.</p>

<blockquote>
  <p>Me: Show me why \(p_i^T A p_j = 0\) applies.</p>

  <p>AI: The property \(p_i^T A p_j = 0\) for \(i \neq j\) in the Conjugate Gradient method is known as the conjugacy of the search directions. This property is crucial for the efficiency and convergence of the method. Let’s go through the reasoning behind this property.</p>
</blockquote>

<h3 id="conjugacy-of-search-directions">Conjugacy of Search Directions</h3>

<p>The search directions \(p_k\) in the Conjugate Gradient method are constructed to be \(A\)-conjugate, meaning:</p>

\[p_i^T A p_j = 0 \quad \text{for} \quad i \neq j\]

<h4 id="derivation">Derivation</h4>

<ol>
  <li>
<strong>Initialization</strong>:
    <ul>
      <li>The first search direction is set to the initial residual: \(p_0 = r_0\).</li>
    </ul>
  </li>
  <li>
<strong>Iterative Update</strong>:
    <ul>
      <li>For each iteration \(k\), the new search direction is computed as:</li>
    </ul>

\[p_{k+1} = r_{k+1} + \beta_k p_k\]

    <p>where</p>

\[\beta_k = \frac{r_{k+1}^T r_{k+1}}{r_k^T r_k}\]
  </li>
  <li>
<strong>Orthogonality of Residuals</strong>:
    <ul>
      <li>The residuals are orthogonal: \(r_i^T r_j = 0\) for \(i \neq j\).</li>
    </ul>
  </li>
  <li>
<strong>Conjugacy Proof</strong>:
    <ul>
      <li>Assume \(p_0, p_1, \ldots, p_k\) are \(A\)-conjugate.</li>
      <li>We need to show that \(p_{k+1}\) is also \(A\)-conjugate to all previous directions.</li>
    </ul>

    <p>Consider \(p_{k+1} = r_{k+1} + \beta_k p_k\). We want to show:</p>

\[p_{k+1}^T A p_j = 0 \quad \text{for} \quad j \leq k\]

    <ul>
      <li>
        <p>For \(j = k\):</p>

\[p_{k+1}^T A p_k = (r_{k+1} + \beta_k p_k)^T A p_k = r_{k+1}^T A p_k + \beta_k p_k^T A p_k\]

        <p>Since \(r_{k+1}\) is orthogonal to \(p_k\) in the \(A\)-norm, \(r_{k+1}^T A p_k = 0\). Also, by the definition of \(\beta_k\), the term \(\beta_k p_k^T A p_k\) does not affect the conjugacy.</p>
      </li>
      <li>
        <p>For \(j &lt; k\):</p>

\[p_{k+1}^T A p_j = (r_{k+1} + \beta_k p_k)^T A p_j = r_{k+1}^T A p_j + \beta_k p_k^T A p_j\]

        <p>Both terms are zero because \(r_{k+1}\) is orthogonal to all previous directions and \(p_k\) is \(A\)-conjugate to \(p_j\).</p>
      </li>
    </ul>
  </li>
</ol>

<h3 id="conclusion">Conclusion</h3>

<p>The conjugacy of the search directions ensures that each update in the Conjugate Gradient method is independent of the others in terms of the \(A\)-norm. This property is crucial for the method’s efficiency, allowing it to converge in at most \(n\) iterations for an \(n \times n\) matrix.</p>

<p>上面AI给出的解释，我始终觉得有问题，就是这一段：</p>

<blockquote>
  <p>Since \(r_{k+1}\) is orthogonal to \(p_k\) in the \(A\)-norm, \(r_{k+1}^T A p_k = 0\). Also, by the definition of \(\beta_k\), the term \(\beta_k p_k^T A p_k\) does not affect the conjugacy.</p>
</blockquote>

<p>\(r_{k+1}\)与\(r_k\)是正交的，而\(r_{k+1}=r_{k}-\alpha_{k}Ap_{k}\)，也即其可以由\(r_k\)和\(A p_k\)线性表达，因此\(r_{k+1}\)不可能与\(Ap_{k}\)正交。再者，\(p_k^T A p_k\)是大于0的，它怎么就不影响\(p_{k+1}\)的conjugacy特性，怎么就能推出\(p_{k+1}^T A p_k=0\)？</p>

<p>反正AI的解释就是糊里糊涂的。下面我来推导一下\(\beta\)的由来，以说明为啥前后\(p_{k}\)是conjugate orthogonal。</p>

<p>Congugate Gradient的核心宗旨是确保\(p_{k+1}^T A p_k=0\), 那么:</p>

\[\begin{align}
(r_{k+1} + \beta A p_{k})^T A p_{k} = 0 \\
r_{k+1}^T A p_k + \beta p_{k}^T A p_k = 0 \\
\beta = -\frac{r_{k+1}^T A p_k}{p_k^T A p_k} \\
\end{align}\]

<p>由前面的推导可知：</p>

\[\begin{align}
r_{k+1} = r_k - \alpha_k A p_k \\
\alpha_k = \frac{r_k^T r_k}{p_k^T A p_k}
\end{align}\]

<p>代入到前面的公式可得：</p>

\[\beta = -\frac{r_{k+1}^T(r_k - r_{k+1})}{\alpha {p_k^T A p_k}}
= \frac{r_{k+1}^T r_{k+1}}{r_k^T r_k}\]

<p>因此，\(\beta\)的特殊取值设计保证了\(p_{k}\)是conjugate orthogonal。</p>

<h2 id="experiments">Experiments</h2>

<p>好了，说里那么多，我们来写一段测试程序验证下该方法的可行性。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_conjugate_gradient</span><span class="p">():</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">transpose</span><span class="p">(</span><span class="n">J</span><span class="p">),</span> <span class="n">J</span><span class="p">)</span>
    <span class="n">x_true</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">x_true</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">x_true: </span><span class="sh">"</span><span class="p">,</span> <span class="n">x_true</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">x: </span><span class="sh">"</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="sh">"</span><span class="s">, error: </span><span class="sh">"</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">norm</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_true</span><span class="p">))</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">r</span>
    <span class="n">r_old</span> <span class="o">=</span> <span class="n">r</span>
    
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
        <span class="n">Ap</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Ap</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">p</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">Ap</span>
        <span class="k">if</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">norm</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">r_old</span><span class="p">,</span> <span class="n">r_old</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">p</span>
        <span class="n">r_old</span> <span class="o">=</span> <span class="n">r</span>
        <span class="n">errors</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">norm</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_true</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">x by CG: </span><span class="sh">"</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="sh">"</span><span class="s">, error: </span><span class="sh">"</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">norm</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_true</span><span class="p">))</span>
    
    <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">conjugate gradient error</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p>这段测试程序很简单，就是生成一个随机的10x10的方阵J，然后构造对称矩阵A。针对给定的x值，生成对应的b，然后通过两种方法（一为numpy内置的线性求解器，二为上面介绍的Conjugate Gradient方法）求解x的估计值。</p>

<p>运行结果如下：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>x_true:  [0.43035432 0.64106726 0.0515147  0.03762809 0.73804567 0.23480996
 0.76863671 0.14293322 0.3014281  0.21103692]
x:  [0.43035432 0.64106726 0.0515147  0.03762809 0.73804567 0.23480996        
 0.76863671 0.14293322 0.3014281  0.21103692] , error:  8.102494088942738e-14 
x by CG:  [0.43035432 0.64106726 0.0515147  0.03762809 0.73804567 0.23480996  
 0.76863671 0.14293322 0.3014281  0.21103692] , error:  2.7416374433878263e-11
</code></pre></div></div>

<p>两种方法计算的结果相当接近，从下面的图示可以看出，收敛速度还挺快，10次迭代后的误差为2.7416374433878263e-11，已经很小了。</p>

<figure>
<img src="https://sunbingfeng.github.io/images/2025-Q2/cg_error.png" alt="img" align="center" class="center_img">
</figure>

<p>通过上面的一个简单实验，说明该方法精度和收敛速度均不错。</p>

    </div>

    
    <button class="toc-toggle" aria-label="Toggle Table of Contents" aria-expanded="false">
        <i class="fas fa-list"></i>
    </button>
    <div class="toc-container">
        <h2>Table of Contents</h2>
        <nav class="toc">
            <ul id="my_toc" class="inline_toc">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#ask-the-ai">Ask the AI</a></li>
  <li><a href="#experiments">Experiments</a></li>
</ul> 
        </nav>
    </div>
    
</div>

<!-- Comments Section - Outside the post-container for full width -->
<div class="comments-wrapper">
    <div class="comments-container">
        <h2>Comments</h2>
        <div class="utterances-container">
                <script src="https://utteranc.es/client.js" repo="sunbingfeng/sunbingfeng.github.io" issue-term="pathname" label="comment" theme="github-light" crossorigin="anonymous" async>
                </script>
            </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tocContainer = document.querySelector('.toc-container');
        const tocToggle = document.querySelector('.toc-toggle');
        const tocLinks = document.querySelectorAll('.toc a');
        const headers = document.querySelectorAll('.post-content h1, .post-content h2, .post-content h3, .post-content h4');
        
        // Show TOC by default on desktop
        if (window.innerWidth > 1024 && tocContainer) {
            tocContainer.style.display = 'block';
        }

        // TOC Toggle for mobile
        if (tocToggle) {
            tocToggle.addEventListener('click', function() {
                const isExpanded = tocToggle.getAttribute('aria-expanded') === 'true';
                tocContainer.classList.toggle('active');
                tocToggle.classList.toggle('active');
                tocToggle.setAttribute('aria-expanded', !isExpanded);
                
                // Toggle display for mobile
                if (window.innerWidth <= 1024) {
                    tocContainer.style.display = isExpanded ? 'none' : 'block';
                }
            });

            // Close TOC when clicking outside
            document.addEventListener('click', function(e) {
                if (tocContainer && 
                    tocContainer.classList.contains('active') && 
                    !tocContainer.contains(e.target) && 
                    !tocToggle.contains(e.target)) {
                    tocContainer.classList.remove('active');
                    tocToggle.classList.remove('active');
                    tocToggle.setAttribute('aria-expanded', 'false');
                    if (window.innerWidth <= 1024) {
                        tocContainer.style.display = 'none';
                    }
                }
            });
        }

        // Update active TOC item on scroll
        function updateTOC() {
            if (!tocLinks.length) return;
            
            const scrollPosition = window.scrollY;
            let currentSection = null;
            
            headers.forEach((header) => {
                const headerTop = header.offsetTop - 100;
                const headerBottom = headerTop + header.offsetHeight;
                
                if (scrollPosition >= headerTop && scrollPosition < headerBottom) {
                    currentSection = header.id;
                }
            });

            if (currentSection) {
                tocLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === `#${currentSection}`) {
                        link.classList.add('active');
                        // Scroll TOC to active item on mobile
                        if (window.innerWidth <= 1024 && tocContainer) {
                            link.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                });
            }
        }

        // Smooth scroll for TOC links
        tocLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href').substring(1);
                const targetElement = document.getElementById(targetId);
                
                if (targetElement) {
                    const headerOffset = 80;
                    const elementPosition = targetElement.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });

                    // Close TOC on mobile after clicking
                    if (window.innerWidth <= 1024) {
                        tocContainer.classList.remove('active');
                        tocToggle.classList.remove('active');
                        tocToggle.setAttribute('aria-expanded', 'false');
                        tocContainer.style.display = 'none';
                    }
                }
            });
        });

        // Update TOC on scroll
        window.addEventListener('scroll', updateTOC);
        // Initial TOC update
        updateTOC();

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 1024) {
                tocContainer.style.display = 'block';
            } else if (!tocContainer.classList.contains('active')) {
                tocContainer.style.display = 'none';
            }
        });
    });
</script> 
    </main>

    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-section">
                <p>© 2025 Bill's Tech Blog. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Theme toggle functionality
        const themeToggle = document.querySelector('.theme-toggle');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const currentTheme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            themeToggle.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }

        setTheme(currentTheme);

        themeToggle.addEventListener('click', () => {
            const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        });

        // KaTeX auto-render
        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false},
                    {left: "\\[", right: "\\]", display: true},
                    {left: "\\(", right: "\\)", display: false}
                ],
                throwOnError: false
            });
        });
    </script>
</body>
</html> 